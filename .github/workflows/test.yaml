name: Monorepo CI/CD

on:
  # Manuell startbar
  workflow_dispatch:
  # Bei Push auf Main
  push:
    branches: [main, master]
  # Bei Pull Requests
  pull_request:
    branches: [main, master]
  # Nightly Build (Erfüllt Anforderung: "regelmäßige Analyse")
  schedule:
    - cron: '0 2 * * *' # Jeden Tag um 02:00 Uhr

permissions:
  contents: write # Für Docs Deployment & Code Checkout
  packages: write # Für Docker Registry Push
  checks: write   # Für Test-Reports

jobs:
  # ------------------------------------------------------------------
  # JOB 1: ÄNDERUNGEN ERKENNEN & MATRIX BAUEN
  # ------------------------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api: ['services/api/**', 'services/common/**']
            worker: ['services/worker/**', 'services/common/**']
            frontend: ['services/frontend/**']

      - id: set-matrix
        run: |
          # Wir bauen ein JSON Array.
          # Bei Nightly Build (schedule) erzwingen wir alles auf 'true'.
          IS_SCHEDULE="${{ github.event_name == 'schedule' }}"
          
          MATRIX_JSON="{\"include\":["
          HAS_CHANGES="false"

          # --- 1. API ---
          if [ "${{ steps.filter.outputs.api }}" == 'true' ] || [ "$IS_SCHEDULE" == "true" ]; then
            MATRIX_JSON="$MATRIX_JSON{\"service\":\"api\",\"path\":\"services/api\",\"type\":\"python\"},"
            HAS_CHANGES="true"
          fi
          
          # --- 2. WORKER ---
          if [ "${{ steps.filter.outputs.worker }}" == 'true' ] || [ "$IS_SCHEDULE" == "true" ]; then
            MATRIX_JSON="$MATRIX_JSON{\"service\":\"worker\",\"path\":\"services/worker\",\"type\":\"python\"},"
            HAS_CHANGES="true"
          fi

          # --- 3. FRONTEND ---
          if [ "${{ steps.filter.outputs.frontend }}" == 'true' ] || [ "$IS_SCHEDULE" == "true" ]; then
            MATRIX_JSON="$MATRIX_JSON{\"service\":\"frontend\",\"path\":\"services/frontend\",\"type\":\"node\"},"
            HAS_CHANGES="true"
          fi
          
          # JSON Syntax fixen (letztes Komma weg)
          if [ "$HAS_CHANGES" == "true" ]; then
             MATRIX_JSON="${MATRIX_JSON%,}]}"
          else
             MATRIX_JSON="{\"include\":[]}"
          fi
          
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------------
  # JOB 2: QS & TESTS (Parallel per Service)
  # Erfüllt: Codeabdeckung, Security Checks, Linting
  # ------------------------------------------------------------------
  qa-and-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    name: QS - ${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4

      # --- PYTHON SETUP ---
      - name: Setup Python
        if: matrix.type == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python Tools
        if: matrix.type == 'python'
        run: |
          cd ${{ matrix.path }}
          pip install -r requirements.txt
          # Tools für Tests, Security und Coverage
          pip install pytest pytest-asyncio httpx ruff pytest-cov bandit pip-audit

      # --- NODE SETUP ---
      - name: Setup Node
        if: matrix.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}/package-lock.json
      
      - name: Install Node Deps
        if: matrix.type == 'node'
        run: |
          cd ${{ matrix.path }}
          npm ci

      # --- LINTING (Style Check) ---
      - name: Linting & Formatting
        run: |
          cd ${{ matrix.path }}
          if [ "${{ matrix.type }}" == "python" ]; then
            echo "Running Ruff..."
            ruff check . 
            ruff format --check .
          else
            echo "Running ESLint..."
            npm run lint --if-present
          fi

      # --- SECURITY (Veraltete Libs & Bugs) ---
      - name: Security Audit
        run: |
          cd ${{ matrix.path }}
          if [ "${{ matrix.type }}" == "python" ]; then
            echo "Running Bandit (Code Security)..."
            bandit -r . -c pyproject.toml --recursive || echo "Bandit issues found"
            
            echo "Running pip-audit (Dependencies)..."
            pip-audit || echo "Vulnerable deps found!"
          else
            echo "Running NPM Audit..."
            npm audit --audit-level=high || echo "NPM Audit found issues"
          fi

      # --- TESTS & COVERAGE ---
      - name: Run Tests
        run: |
          cd ${{ matrix.path }}
          if [ "${{ matrix.type }}" == "python" ]; then
            # Erzeugt coverage.xml/html für den Beweis
            pytest --cov=. --cov-report=xml --cov-report=html
          else
            npm run test:coverage --if-present
          fi

      # --- ARTIFACTS (Beweis für Note) ---
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: |
            ${{ matrix.path }}/htmlcov
            ${{ matrix.path }}/coverage
          retention-days: 14

  # ------------------------------------------------------------------
  # JOB 3: INTEGRATION GATEKEEPER
  # Fährt Docker Compose hoch und prüft Interaktion
  # ------------------------------------------------------------------
  integration-test:
    needs: [qa-and-test]
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python (Test Runner)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - run: pip install pytest httpx
      
      - name: Start Full Stack
        run: docker-compose -f docker-compose.test.yml up -d --build

      - name: Wait for API
        run: timeout 60s bash -c 'until curl -s http://localhost:8000/health > /dev/null; do sleep 2; done'

      - name: Run Integration Tests
        run: pytest tests/integration/

      - name: Dump Logs on Failure
        if: failure()
        run: docker-compose -f docker-compose.test.yml logs

      - name: Teardown
        if: always()
        run: docker-compose -f docker-compose.test.yml down

  # ------------------------------------------------------------------
  # JOB 4: DOKUMENTATION (MkDocs)
  # Erfüllt: "Dokumentationsgenerierung" & "Veröffentlichung"
  # ------------------------------------------------------------------
  deploy-docs:
    needs: [qa-and-test]
    if: github.ref == 'refs/heads/main' # Nur auf Main
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: 
          python-version: '3.11'
      - run: pip install mkdocs-material mkdocstrings[python]
      - name: Build & Deploy Docs
        run: mkdocs gh-deploy --force

  # ------------------------------------------------------------------
  # JOB 5: BUILD & PUSH
  # Läuft nur, wenn alles oben grün ist.
  # ------------------------------------------------------------------
  build-and-push:
    needs: [integration-test]
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          file: ${{ matrix.path }}/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/${{ matrix.service }}:latest

  # ------------------------------------------------------------------
  # JOB 6: STATUS CHECK (Für Branch Protection)
  # ------------------------------------------------------------------
  ci-status-check:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    steps:
      - run: |
          if [ "${{ needs.build-and-push.result }}" == "failure" ] || [ "${{ needs.build-and-push.result }}" == "cancelled" ]; then
            echo "Pipeline Failed"
            exit 1
          fi
          echo "Pipeline Success (or Skipped correctly)"
          exit 0